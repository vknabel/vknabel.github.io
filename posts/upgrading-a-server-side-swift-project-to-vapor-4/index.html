<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Upgrading a server-side Swift project to Vapor 4 - vknabel</title><link rel=icon type=image/png href=/images/vknabel.jpg><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The past few days I created a new server using Vapor and hit vapor new <project> --auth which created a Vapor 3 server. Later I upgraded the young project to Vapor 4, but found some lack of practical information about the upgrade on the internet. So here I share my subjective experience and try to give you some tips.
The app itself is relatively simple:

it has user authentication and registration
users don‚Äòt have any profile and cannot interact with each other
on certain events, we notify multiple users on all of their devices
users have their personal list of notifications

After a while, when most parts of the MVP were finished, I wanted to add vapor/apns, which required the new Vapor 4. But hasn‚Äôt Vapor 4 been released recently? Yes, but it seems like the Vapor team probably decided to keep Vapor 3 the default until the documentation and all surrounding has been finished (which is a good thing!)."><meta property="og:image" content><meta property="og:url" content="https://vknabel.com/posts/upgrading-a-server-side-swift-project-to-vapor-4/"><meta property="og:site_name" content="vknabel"><meta property="og:title" content="Upgrading a server-side Swift project to Vapor 4"><meta property="og:description" content="The past few days I created a new server using Vapor and hit vapor new <project> --auth which created a Vapor 3 server. Later I upgraded the young project to Vapor 4, but found some lack of practical information about the upgrade on the internet. So here I share my subjective experience and try to give you some tips.
The app itself is relatively simple:
it has user authentication and registration users don‚Äòt have any profile and cannot interact with each other on certain events, we notify multiple users on all of their devices users have their personal list of notifications After a while, when most parts of the MVP were finished, I wanted to add vapor/apns, which required the new Vapor 4. But hasn‚Äôt Vapor 4 been released recently? Yes, but it seems like the Vapor team probably decided to keep Vapor 3 the default until the documentation and all surrounding has been finished (which is a good thing!)."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-22T00:00:00+00:00"><meta property="article:modified_time" content="2020-04-22T00:00:00+00:00"><meta property="article:tag" content="Swift"><meta property="article:tag" content="Vapor"><meta property="article:tag" content="Migration"><meta name=twitter:card content="summary"><meta name=twitter:title content="Upgrading a server-side Swift project to Vapor 4"><meta name=twitter:description content="The past few days I created a new server using Vapor and hit vapor new <project> --auth which created a Vapor 3 server. Later I upgraded the young project to Vapor 4, but found some lack of practical information about the upgrade on the internet. So here I share my subjective experience and try to give you some tips.
The app itself is relatively simple:
it has user authentication and registration users don‚Äòt have any profile and cannot interact with each other on certain events, we notify multiple users on all of their devices users have their personal list of notifications After a while, when most parts of the MVP were finished, I wanted to add vapor/apns, which required the new Vapor 4. But hasn‚Äôt Vapor 4 been released recently? Yes, but it seems like the Vapor team probably decided to keep Vapor 3 the default until the documentation and all surrounding has been finished (which is a good thing!)."><script src=https://vknabel.com/js/feather.min.js></script><link href=https://vknabel.com/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://vknabel.com/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://vknabel.com/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=/css/overrides.css></head><body><div class=content><header><div class=main><a href=https://vknabel.com/>vknabel</a></div><nav><a href=/>blog</a>
<a href=/tils>tils</a>
<a href=/about>about</a>
<a href=/tags>tags</a></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>Upgrading a server-side Swift project to Vapor 4</h1><div class=meta>Posted on Apr 22, 2020</div></div><section class=body><p>The past few days I created a new server using <a href=https://vapor.codes>Vapor</a> and hit <code>vapor new &lt;project> --auth</code> which created a Vapor 3 server. Later I upgraded the young project to Vapor 4, but found some lack of practical information about the upgrade on the internet. So here I share my subjective experience and try to give you some tips.</p><p>The app itself is relatively simple:</p><ul><li>it has user authentication and registration</li><li>users don‚Äòt have any profile and cannot interact with each other</li><li>on certain events, we notify multiple users on all of their devices</li><li>users have their personal list of notifications</li></ul><p>After a while, when most parts of the MVP were finished, I wanted to add <a href=https://github.com/vapor/apns>vapor/apns</a>, which required the new Vapor 4. But hasn‚Äôt Vapor 4 been released recently? Yes, but it seems like the Vapor team probably decided to keep Vapor 3 the default until the documentation and all surrounding has been finished (which is a good thing!).</p><p>The <a href=https://forums.swift.org/t/whats-new-in-vapor-4/31832>list of changes</a> reads nicely, new services API, new model API built on top of property wrappers looks gorgeous, synchronously decoding contents improves controllers far more than you might expect and eager loading is great to tune up performance and to even reduce the amount of nested futures to be handled.</p><p>As mentioned I was especially interested in APNS. Additionally I need background jobs, which come as <a href=https://github.com/vapor/queues>vapor/queues</a> , too.
For me the decision was an obvious one: let‚Äòs upgrade the code base!</p><h2 id=starting-the-migration-from-vapor-3-to-vapor-4>Starting the Migration from Vapor 3 to Vapor 4</h2><p>At that time, the server had only 4 controllers, 10 routes, 13 request_response structs_enums, 6 models, only empty migrations, zero services and zero repositories. It was still using an SQLite in-memory database with SQLite imports and types spread across the whole project. Also it obviously didn‚Äòt send any Push Notifications (although they were already stored).</p><p>So as a first step to upgrade Vapor, I head over to their <a href=https://docs.vapor.codes/4.0/upgrading/>Upgrading Docs</a> and started with updating the Package.swift manifest dependencies and platforms as proposed. Apparently I could even drop the vapor/auth dependency as it is now included in Vapor 4. You might stumble upon <code>platforms: [.macOS(.v10_15)]</code>: no worries, it still supports Linux. üëç</p><h3 id=configure>Configure</h3><p>Next I copied the new proposed contents of <code>Sources/Run/main.swift</code>, deleted <code>Sources/App/app.swift</code>, <code>Sources/App/boot.swift</code> (it was still empty) and changed <code>configure(_:_:_:)</code> and <code>routes(_:_:)</code> to be of type <code>(Application) throws -> Void</code>.</p><p>As I already touched <code>configure(_:)</code> and <code>routes(_:)</code>, I wanted to make those two files compile first, before moving to the next files, but the upgrading docs didn‚Äòt really serve me well here. After some time reading through docs, I decided to generate a new Vapor 4 reference project using <code>vapor-beta new Example</code> which used <a href=https://github.com/vapor/template>vapor/template</a> as template.</p><p>When comparing <a href=https://github.com/vapor/api-template/blob/master/Sources/App/configure.swift>Vapor 3 api-template configure.swift</a> with the <a href=https://github.com/vapor/template/blob/master/Sources/App/configure.swift>new one</a> I came to the conclusion, I could drop the most code.</p><p>In Vapor 3 we usually started creating a <code>XxxConfig</code> where we added types of migrations or used middlewares or databases.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Vapor 3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Vapor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Fluent</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>FluentSQLite</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>configure</span>(<span style=color:#66d9ef>_</span> config: <span style=color:#66d9ef>inout</span> Config, <span style=color:#66d9ef>_</span> env: <span style=color:#66d9ef>inout</span> Environment, <span style=color:#66d9ef>_</span> services: <span style=color:#66d9ef>inout</span> Services) <span style=color:#66d9ef>throws</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Register providers first</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span> services.register(FluentSQLiteProvider())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Register routes to the router</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>let</span> router = EngineRouter.<span style=color:#66d9ef>default</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span> routes(router)
</span></span><span style=display:flex><span>	services.register(router, <span style=color:#66d9ef>as</span>: Router.<span style=color:#66d9ef>self</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Configure a SQLite database</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>let</span> sqlite = <span style=color:#66d9ef>try</span> SQLiteDatabase(storage: .memory)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Register the configured SQLite database to the database config.</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> databases = DatabasesConfig()
</span></span><span style=display:flex><span>	databases.add(database: sqlite, <span style=color:#66d9ef>as</span>: .sqlite)
</span></span><span style=display:flex><span>	services.register(databases)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Register middleware</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> middlewares = MiddlewareConfig()
</span></span><span style=display:flex><span>	middlewares.use(ErrorMiddleware.<span style=color:#66d9ef>self</span>)
</span></span><span style=display:flex><span>	services.register(middlewares)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Register migrations</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> migrations = MigrationConfig()
</span></span><span style=display:flex><span>	migrations.add(model: User.<span style=color:#66d9ef>self</span>, database: .sqlite) <span style=color:#75715e>// Note: it‚Äòs a type!</span>
</span></span><span style=display:flex><span>	services.register(migrations)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>With Vapor 4, we just add instances of those types to <code>app.xxx</code> directly instead. Much more readable!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Vapor 4</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Vapor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Fluent</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>FluentSQLiteDriver</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>configure</span>(<span style=color:#66d9ef>_</span> app: Application) <span style=color:#66d9ef>throws</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span> app.databases.use(.sqlite(.memory), <span style=color:#66d9ef>as</span>: DatabaseID.sqlite)
</span></span><span style=display:flex><span>	app.middleware.use(ErrorMiddleware.<span style=color:#66d9ef>default</span>(environment: app.environment))
</span></span><span style=display:flex><span>	app.migrations.add(CreateUser()) <span style=color:#75715e>// Note: here it‚Äòs an instance!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>try</span> routes(app)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now our <code>configure.swift</code> should only complain about our migrations, so let‚Äòs head over to fix those!</p><h3 id=models>Models</h3><p>Before we can fix our migrations, we should upgrade our models! For this step, it‚Äôs best to start bottom up from your simplest models to your most complex ones with lots of relations. Be patient and do one step at a time.</p><p>Here is our example model in Vapor 3:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Vapor 3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Vapor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>FluentSQLite</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DeviceToken</span>: SQLiteModel {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>typealias</span> Database = SQLiteDatabase
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>let</span> createdAtKey: TimestampKey? = <span style=color:#960050;background-color:#1e0010>\</span>.createdAt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> id: Int? <span style=color:#75715e>// Note the Int? As id!</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> value: String
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>var</span> userID: User.ID
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>var</span> createdAt: Date?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	  <span style=color:#66d9ef>var</span> user: Parent&lt;DeviceToken, User&gt; { parent(<span style=color:#960050;background-color:#1e0010>\</span>.userID) }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>init</span>(id: Int? = <span style=color:#66d9ef>nil</span>, value: String, user: User) <span style=color:#66d9ef>throws</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.id = id
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.value = value
</span></span><span style=display:flex><span>		  <span style=color:#66d9ef>self</span>.userID = <span style=color:#66d9ef>try</span> user.requireID()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And here is the interesting part: our new Vapor 4 variant of <code>DeviceToken</code>!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Fluent</span> <span style=color:#75715e>// 1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Vapor 4</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DeviceToken</span>: Model {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>let</span> schema = <span style=color:#e6db74>&#34;device_tokens&#34;</span> <span style=color:#75715e>// 2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	@ID(key: .id) <span style=color:#75715e>// 3</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> id: Int?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	@Field(key: <span style=color:#e6db74>&#34;value&#34;</span>) <span style=color:#75715e>// 4</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> value: String
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	@Parent(key: <span style=color:#e6db74>&#34;user_id&#34;</span>) <span style=color:#75715e>// 5</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> user: User
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	@Timestamp(key: <span style=color:#e6db74>&#34;created_at&#34;</span>, on: .create) <span style=color:#75715e>// 6</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> createdAt: Date?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>init</span>() {} <span style=color:#75715e>// 7 this is required, but in my case always empty ^^</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>init</span>(id: UUID? = <span style=color:#66d9ef>nil</span>, value: String, user: User) <span style=color:#66d9ef>throws</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>self</span>.id = id
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>self</span>.value = value
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 8</span>
</span></span><span style=display:flex><span>		<span style=color:#75715e>// ATTENTION: using self.user = user crashes</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>self</span>.<span style=color:#960050;background-color:#1e0010>$</span>user.id = <span style=color:#66d9ef>try</span> user.requireID()
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>self</span>.<span style=color:#960050;background-color:#1e0010>$</span>user.value = user
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Quite a lot to explain here, although it should be rather straight-forward. Essentially we:</p><ol><li>drop the fluent database import</li><li>replace the database typealias with the name of our schema (e.g. table name)</li><li>add the <code>@ID(key: .id)</code> property wrapper</li><li>mark every field with <code>@Field(key: "name_of_field_in_schema")</code> (giving the column name)</li><li>declare the parent<ol><li>remove old <code>var userID: User.ID</code></li><li>replace old computed <code>var user: Parent&lt;DeviceToken, User> { parent(\.userID) }</code></li><li>with <code>@Parent(key: "user_id") var user: User</code></li><li>The same rules apply to children and siblings</li></ol></li><li>Instead of declaring static <code>createdAtKey</code>, <code>updatedAtKey</code> and <code>deletedAtKey</code> use <code>@Timestamp(key: FieldKey, on: TimestampTrigger)</code> as seen above</li><li>add an empty <code>init() {}</code>. Not sure when to customize and what its for ü§î</li><li>Here you need to pay attention! You may never set your relations directly, always use <code>$user.value =</code> or <code>$user.id =</code>. In this case we set both resulting in an already eager loaded <code>user</code>.</li></ol><p>Oh and if your models conform to <code>Parameter</code>: just remove it. It has been removed.</p><h3 id=migrations>Migrations</h3><p>As our models are fine now, let‚Äôs dive into their migrations!</p><p>Previously it was a common practice to conform your models to <code>Migration</code> and to even let Fluent derive a default migration from your <code>Model</code>. Though with Vapor 4 we need to actually implement those. I mean, conforming your models to migration isn‚Äòt scalable anyways. So after all it‚Äòs a good change.</p><p>Although I am generally a fan of doing just one single change at a time, I think this a great opportunity to move your migrations into separate files inside a <code>Migrations</code> folder, if they are still in the same file as their models.</p><p>From all I know, your existing migrations will break, but they should be rather easy to migrate. Anyways I didn‚Äòt have real migrations, just the default ones:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Vapor 3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Fluent</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>DeviceToken</span>: Migration { }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Alternatively manual migrations</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>FluentPostgreSQL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>Domain</span>: Migration {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>prepare</span>(on conn: PostgreSQLConnection) -&gt; Future&lt;Void&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> PostgreSQLDatabase.create(DeviceToken.<span style=color:#66d9ef>self</span>, on: conn) { builder <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>            builder.field(<span style=color:#66d9ef>for</span>: <span style=color:#960050;background-color:#1e0010>\</span>.id, isIdentifier: <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>            builder.field(<span style=color:#66d9ef>for</span>: <span style=color:#960050;background-color:#1e0010>\</span>.value)
</span></span><span style=display:flex><span>            builder.field(<span style=color:#66d9ef>for</span>: <span style=color:#960050;background-color:#1e0010>\</span>.userID)
</span></span><span style=display:flex><span>            builder.reference(from: <span style=color:#960050;background-color:#1e0010>\</span>.userID, to: <span style=color:#960050;background-color:#1e0010>\</span>User.id)
</span></span><span style=display:flex><span>			  builder.field(<span style=color:#66d9ef>for</span>: <span style=color:#960050;background-color:#1e0010>\</span>.createdAt)
</span></span><span style=display:flex><span>			  builder.unique(on: <span style=color:#960050;background-color:#1e0010>\</span>.value)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p><strong>Some personal note:</strong> I prefer to use the actual relation entities the in initializers. That way I have compiler guarantees, that their id actually exist!</p></blockquote><p>So let‚Äòs get our hands dirty and write some migrations in Vapor 4.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Vapor 4</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Fluent</span> <span style=color:#75715e>// Note: we don‚Äòt have to specify the database type!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>CreateDeviceToken</span>: Migration {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>prepare</span>(on: database: Database) -&gt; EventLoopFuture&lt;Void&gt; {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> database.schema(<span style=color:#e6db74>&#34;device_tokens&#34;</span>)
</span></span><span style=display:flex><span>			.id() <span style=color:#75715e>// &lt;- oops! This is always .uuid, not .int which is not available on SQLite</span>
</span></span><span style=display:flex><span>			.field(<span style=color:#e6db74>&#34;value&#34;</span>, .string, .<span style=color:#66d9ef>required</span>)
</span></span><span style=display:flex><span>			.field(<span style=color:#e6db74>&#34;user_id&#34;</span>, .uuid, .<span style=color:#66d9ef>required</span>, .references(<span style=color:#e6db74>&#34;users&#34;</span>, <span style=color:#e6db74>&#34;id‚Äú))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>			.field(&#34;</span>created_at<span style=color:#e6db74>&#34;, .datetime, .required)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>			.unique(on: &#34;</span>value<span style=color:#e6db74>&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>			.create()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	func revert(on database: Database) -&gt; EventLoopFuture&lt;Void&gt; {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		return database.schema(&#34;</span>device_tokens<span style=color:#e6db74>&#34;).delete()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span></code></pre></div><p>At first, we notice much more strings than key paths and that all migrations have to rewritten! Though the upgrade should be comparably easy. If you have a lot migrations, you might have a though job as <code>revert(on:)</code> is mandatory now. Hopefully we will never need to revert any migrations in production!</p><blockquote><p>Another thing to note: I was using SQLite, but the <code>.id()</code>-shorthand is hard-coded to use type <code>.uuid</code>:</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// From Fluent‚Äôs source code</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SchemaBuilder</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>id</span>() -&gt; <span style=color:#66d9ef>Self</span> {
</span></span><span style=display:flex><span>  		<span style=color:#66d9ef>self</span>.field(.id, .uuid, .identifier(auto: <span style=color:#66d9ef>false</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>As the models and migrations were already independent of the database technology, I decided to switch from SQLite to Postgres, especially as models are now independent of the underlaying database (you import <code>Fluent</code> instead of <code>Fluent{Database}</code>), this change was quite easy and did only affect <code>Package.swift</code> and <code>configure.swift</code>. If you don‚Äòt, you probably need to use <code>.field(.id, .int, .identifier(auto: true))</code> instead of <code>.id</code>.</p></blockquote><p>If you don‚Äôt use any authentication, <code>configure.swift</code>, all your models and migrations should compile without any errors!</p><h3 id=authentication>Authentication</h3><p>As I didn‚Äôt tune my current authentication implementation, I tried to stick as close as possible to the new <a href=https://docs.vapor.codes/4.0/authentication/>Vapor: Security ‚Üí Authentication</a> docs.</p><blockquote><p>Because the app will have a password less login, I didn‚Äôt use any basic authentication, which is therefore missing below. But according to the docs, it should be relatively easy to implement.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> Vapor 3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Vapor</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Authentication</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>User</span>: TokenAuthenticatable {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/// See `TokenAuthenticatable`.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>typealias</span> TokenType = UserToken
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserToken</span>: SQLiteModel {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>create</span>(userID: User.ID) <span style=color:#66d9ef>throws</span> -&gt; UserToken {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// generate a random 128-bit, base64-encoded string.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> string = <span style=color:#66d9ef>try</span> CryptoRandom().generateData(count: <span style=color:#ae81ff>16</span>).base64EncodedString()
</span></span><span style=display:flex><span>        <span style=color:#75715e>// init a new `UserToken` from that string.</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .<span style=color:#66d9ef>init</span>(string: string, userID: userID)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/// Allows this model to be used as a TokenAuthenticatable‚Äôs token.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>UserToken</span>: Token {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/// See `Token`.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>typealias</span> UserType = User
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/// See `Token`.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>var</span> tokenKey: WritableKeyPath&lt;UserToken, String&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#960050;background-color:#1e0010>\</span>.string
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/// See `Token`.</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>var</span> userIDKey: WritableKeyPath&lt;UserToken, User.ID&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#960050;background-color:#1e0010>\</span>.userID
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Actually upgrading this, took me some time, since parts of the logic are now reversed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Vapor 4</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Vapor</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 2</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>User</span>: Authenticatable {
</span></span><span style=display:flex><span>	  <span style=color:#75715e>// 3</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>generateToken</span>() <span style=color:#66d9ef>throws</span> -&gt; UserToken {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> UserToken(
</span></span><span style=display:flex><span>            value: [UInt8].random(count: <span style=color:#ae81ff>16</span>).base64,
</span></span><span style=display:flex><span>            user: <span style=color:#66d9ef>self</span>
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 4</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>UserToken</span>: ModelTokenAuthenticatable {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>let</span> valueKey = <span style=color:#960050;background-color:#1e0010>\</span>UserToken.<span style=color:#960050;background-color:#1e0010>$</span>value
</span></span><span style=display:flex><span>  	<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>let</span> userKey = <span style=color:#960050;background-color:#1e0010>\</span>UserToken.<span style=color:#960050;background-color:#1e0010>$</span>user
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 5</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> isValid: Bool {
</span></span><span style=display:flex><span>	  Date() <span style=color:#f92672>&gt;=</span> expiresAt ?? Date()
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li>First of all: drop the Authentication import. Vapor is enough.</li><li>Now we mark <code>User</code> as <code>Authenticatable</code> instead of <code>TokenAuthenticatable</code>. This allows you to decode it in your controllers!</li><li>Essentially we moved the static <code>UserToken.create</code> to <code>User.generateToken</code> and updated it to use Swift‚Äôs latest APIs. Completely optional.</li><li>The old <code>Token</code> protocol will be replaced by <code>ModelTokenAuthenticatable</code> where we get rid of the <code>UserType</code>-typealias and rename the static constants for key paths. And we prefix them with <code>$</code> to select the field property wrappers instead of their values.</li><li>The docs proposed <code>isValid</code> to always be <code>true</code>, though as I kept <code>expiredAt</code>, I chose a real implementation.</li></ol><p>At this point, your models, migrations and your configure should be free from errors.</p><p>Some small changes in your routes and we can put a check at authentication. Though as these are very well documented and highly specific to your application, I‚Äôll keep this short!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Vapor 3</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> bearer = router.grouped(User.tokenAuthMiddleware())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// </span><span style=color:#75715e>MARK:</span><span style=color:#75715e> - Vapor 4</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> bearer = app.grouped(UserToken.authenticator()) <span style=color:#75715e>// note the UserToken instead of User</span>
</span></span></code></pre></div><h3 id=services-and-repositories>Services and Repositories</h3><p>As I didn‚Äôt use services and repositories yet, I have no more detailed help for you, but from reading the appropriate upgrading chapters <a href=https://docs.vapor.codes/4.0/upgrading/#services>Upgrading Services</a> and <a href=https://docs.vapor.codes/4.0/upgrading/#repositories>Upgrading Repositories</a>, it should be straightforward anyways.</p><h3 id=routes-and-controllers-learnings>Routes and Controllers, Learnings</h3><p>Now only routes and controllers should be left. As routes and controllers are tied together, I both simultaneously. One route and method at a time.</p><p>Here I won‚Äôt provide lots of actual code diffs as above, because even the list of all subtle changes is impressive and far from complete.</p><ul><li>instead of <code>Model.parameter</code> in your routes name it <code>":model_id"</code>, in your controller replace <code>req.parameters.next(_:)</code>with <code>Model.find(req.parameters.get("model_id"), on: req.db)</code></li><li>if you have route components with a <code>/</code> inside, split them up</li><li>There are less extensions on <code>req</code>, but more vars
_ Use <code>req.auth.require(_:)</code>instead of<code>req.requireAuthenticated(_:)</code>
_ <code>DeviceToken.query(on: req.db)</code></li><li><code>req.content.decode(_:)</code> is now synchronous</li><li>In queries, your key paths should end with fields (just share some $)
_ <code>.filter(\.$token == deviceToken)</code>_<code>.filter(\.$user.$id == user.id)</code></li><li><code>.save(on:)</code> now returns <code>Void</code>
_ either add a new func <code>saveAndReturn(on database: Database) -> EventLoopFuture&lt;Self></code> on <code>Model</code>
_ or use <code>x.save(on: req.db).transform(to: x)</code></li><li>Async
_ <code>map</code> and <code>flatMap</code> may not throw anymore (you can temporarily add overloads marked as <code>@available(_, deprecated)</code>to get warnings) * there is no global<code>flatMap(_:_:)</code>anymore, instead use<code>.and(_:).flatMap(_:)</code></li><li>Relations
_ direct access of relations like <code>token.user</code> crashes if not loaded eagerly using <code>.with(\.$user)</code> (<code>QueryBuilder&lt;Model>.with(_:KeyPath&lt;Self, Relation>)</code>) _ for save, synchronous access use<code>token.$user.value?</code>or for async access<code>token.$user.get(on:)</code>or<code>.query(on:)</code>_ directly setting<code>token.user =</code>always fails; use<code>token.$user.value =</code>or<code>token.$user.id =</code>_ when setting<code>token.$user.value =</code>, it does not update<code>token.$user.id</code>! You need to do both, but then your data has been loaded eagerly!</li></ul><h2 id=where-to-go-from-here>Where to go from here?</h2><p>Most of your server should be migrated. What‚Äôs missing are view renderers, your tests (though they should not break) and more advanced feature. But most effort should be finished.</p><p>Even in my small application, the upgrade required a reasonable amount of work, though it was mostly about diffing existing code and documentation. On the other hand the Vapor team did a great job to produce compile errors instead of runtime errors!
As someone who upgraded several large single page web apps, this was a bless!</p><p>Did this help you? Have you found a bug? What was your upgrade like? Let‚Äôs have a chat on <a href=https://mastodon.social/@vknabel>@mastodon.social@vknabel</a> and feel free to <a href=https://github.com/vknabel/vknabel.github.io/issues/new>open an issue on GitHub</a>.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/swift>swift</a></li><li><a href=/tags/vapor>vapor</a></li><li><a href=/tags/migration>migration</a></li></ul></nav></div></div></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/vknabel rel=me title=GitHub><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github"/></svg></a><a class=border></a><a class=soc href=https://mastodon.social/@vknabel/ rel=me title=Mastodon><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#at-sign"/></svg></a><a class=border></a></div><div class=footer-info>2025 ¬© Valentin Knabel | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>