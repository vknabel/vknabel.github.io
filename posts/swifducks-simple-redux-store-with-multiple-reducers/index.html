<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Swifducks: simple Redux store with multiple reducers - vknabel</title><link rel=icon type=image/png href=/images/vknabel.jpg><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A simple example implementation of the Redux pattern with multiple reducers and listeners.
The name is derived from Swift + Redux = üèéü¶Ü
Originally written at 2018-06-10
Definitions
public final class Store<State, Action> {
    public typealias Reducer = (Action, inout State) -> Void

    public private(set) var state: State
    private var reducers: [Reducer] = []
    private var callbacks: [Weak<Listener<State>>] = []

    public init(initial state: State) {
        self.state = state
    }

    public func select(_ changes: @escaping (State) -> Void) -> Any {
        let subscription = Listener(on: changes)
        callbacks.append(Weak(subscription))
        return subscription
    }

    private func reduce(with reducer: @escaping Reducer) {
        reducers.append(reducer)
    }

    public func dispatch(_ action: Action) {
        state = reducers.reduce(into: state) { intermediate, reducer in
            reducer(action, &amp;intermediate)
        }
        callbacks = callbacks
            .compactMap { $0.value }
            .map(Weak.init)
        callbacks.forEach { $0.value?.onChange(state) }
    }
}

public extension Store {
    convenience init(initial state: State, reducer: @escaping Reducer) {
        self.init(initial: state)
        reduce(with: reducer)
    }
}

internal struct Weak<A: AnyObject> {
    weak var value: A?

    init(_ value: A?) {
        self.value = value
    }
}

internal final class Listener<State> {
    var onChange: (State) -> Void

    init(on change: @escaping (State) -> Void) {
        onChange = change
    }
}
Example Usage
enum IntAction {
    case increase
    case decrease
}

let root = Store<Int, IntAction>(initial: 0) { action, state in
    switch action {
    case .increase:
        state += 1
    case .decrease:
        state -= 1
    }
}

var sideEffect = -1
var listener: Any? = root.select {
    sideEffect = $0
}

root.dispatch(.increase)
root.state // will be 1
sideEffect // will be 1
listener = nil
root.dispatch(.decrease)
root.state // will be 0
sideEffect // will be 1
Conclusion
Without explicit support for modularity, supporting multiple reducers as above is probably not needed. Instead some composability functions should be used."><meta property="og:image" content><meta property="og:url" content="https://vknabel.com/posts/swifducks-simple-redux-store-with-multiple-reducers/"><meta property="og:site_name" content="vknabel"><meta property="og:title" content="Swifducks: simple Redux store with multiple reducers"><meta property="og:description" content="A simple example implementation of the Redux pattern with multiple reducers and listeners.
The name is derived from Swift + Redux = üèéü¶Ü
Originally written at 2018-06-10
Definitions public final class Store<State, Action> { public typealias Reducer = (Action, inout State) -> Void public private(set) var state: State private var reducers: [Reducer] = [] private var callbacks: [Weak<Listener<State>>] = [] public init(initial state: State) { self.state = state } public func select(_ changes: @escaping (State) -> Void) -> Any { let subscription = Listener(on: changes) callbacks.append(Weak(subscription)) return subscription } private func reduce(with reducer: @escaping Reducer) { reducers.append(reducer) } public func dispatch(_ action: Action) { state = reducers.reduce(into: state) { intermediate, reducer in reducer(action, &amp;intermediate) } callbacks = callbacks .compactMap { $0.value } .map(Weak.init) callbacks.forEach { $0.value?.onChange(state) } } } public extension Store { convenience init(initial state: State, reducer: @escaping Reducer) { self.init(initial: state) reduce(with: reducer) } } internal struct Weak<A: AnyObject> { weak var value: A? init(_ value: A?) { self.value = value } } internal final class Listener<State> { var onChange: (State) -> Void init(on change: @escaping (State) -> Void) { onChange = change } } Example Usage enum IntAction { case increase case decrease } let root = Store<Int, IntAction>(initial: 0) { action, state in switch action { case .increase: state += 1 case .decrease: state -= 1 } } var sideEffect = -1 var listener: Any? = root.select { sideEffect = $0 } root.dispatch(.increase) root.state // will be 1 sideEffect // will be 1 listener = nil root.dispatch(.decrease) root.state // will be 0 sideEffect // will be 1 Conclusion Without explicit support for modularity, supporting multiple reducers as above is probably not needed. Instead some composability functions should be used."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-15T00:00:00+00:00"><meta property="article:modified_time" content="2019-10-15T00:00:00+00:00"><meta property="article:tag" content="Swift"><meta property="article:tag" content="Experiment"><meta property="article:tag" content="Functional"><meta name=twitter:card content="summary"><meta name=twitter:title content="Swifducks: simple Redux store with multiple reducers"><meta name=twitter:description content="A simple example implementation of the Redux pattern with multiple reducers and listeners.
The name is derived from Swift + Redux = üèéü¶Ü
Originally written at 2018-06-10
Definitions public final class Store<State, Action> { public typealias Reducer = (Action, inout State) -> Void public private(set) var state: State private var reducers: [Reducer] = [] private var callbacks: [Weak<Listener<State>>] = [] public init(initial state: State) { self.state = state } public func select(_ changes: @escaping (State) -> Void) -> Any { let subscription = Listener(on: changes) callbacks.append(Weak(subscription)) return subscription } private func reduce(with reducer: @escaping Reducer) { reducers.append(reducer) } public func dispatch(_ action: Action) { state = reducers.reduce(into: state) { intermediate, reducer in reducer(action, &amp;intermediate) } callbacks = callbacks .compactMap { $0.value } .map(Weak.init) callbacks.forEach { $0.value?.onChange(state) } } } public extension Store { convenience init(initial state: State, reducer: @escaping Reducer) { self.init(initial: state) reduce(with: reducer) } } internal struct Weak<A: AnyObject> { weak var value: A? init(_ value: A?) { self.value = value } } internal final class Listener<State> { var onChange: (State) -> Void init(on change: @escaping (State) -> Void) { onChange = change } } Example Usage enum IntAction { case increase case decrease } let root = Store<Int, IntAction>(initial: 0) { action, state in switch action { case .increase: state += 1 case .decrease: state -= 1 } } var sideEffect = -1 var listener: Any? = root.select { sideEffect = $0 } root.dispatch(.increase) root.state // will be 1 sideEffect // will be 1 listener = nil root.dispatch(.decrease) root.state // will be 0 sideEffect // will be 1 Conclusion Without explicit support for modularity, supporting multiple reducers as above is probably not needed. Instead some composability functions should be used."><script src=https://vknabel.com/js/feather.min.js></script><link href=https://vknabel.com/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://vknabel.com/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://vknabel.com/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=/css/overrides.css></head><body><div class=content><header><div class=main><a href=https://vknabel.com/>vknabel</a></div><nav><a href=/>blog</a>
<a href=/tils>tils</a>
<a href=/about>about</a>
<a href=/tags>tags</a></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>Swifducks: simple Redux store with multiple reducers</h1><div class=meta>Posted on Oct 15, 2019</div></div><section class=body><p>A simple example implementation of the Redux pattern with multiple reducers and listeners.</p><p>The name is derived from Swift + Redux = üèéü¶Ü</p><p><em>Originally written at 2018-06-10</em></p><h2 id=definitions>Definitions</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Store</span>&lt;State, Action&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>typealias</span> Reducer = (Action, <span style=color:#66d9ef>inout</span> State) -&gt; Void
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>private</span>(<span style=color:#66d9ef>set</span>) <span style=color:#66d9ef>var</span> state: State
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> reducers: [Reducer] = []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> callbacks: [Weak&lt;Listener&lt;State&gt;<span style=color:#f92672>&gt;</span>] = []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>init</span>(initial state: State) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.state = state
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>select</span>(<span style=color:#66d9ef>_</span> changes: @escaping (State) -&gt; Void) -&gt; Any {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> subscription = Listener(on: changes)
</span></span><span style=display:flex><span>        callbacks.append(Weak(subscription))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> subscription
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>reduce</span>(with reducer: @escaping Reducer) {
</span></span><span style=display:flex><span>        reducers.append(reducer)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>dispatch</span>(<span style=color:#66d9ef>_</span> action: Action) {
</span></span><span style=display:flex><span>        state = reducers.reduce(into: state) { intermediate, reducer <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>            reducer(action, &amp;intermediate)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        callbacks = callbacks
</span></span><span style=display:flex><span>            .compactMap { $0.value }
</span></span><span style=display:flex><span>            .map(Weak.<span style=color:#66d9ef>init</span>)
</span></span><span style=display:flex><span>        callbacks.forEach { $0.value?.onChange(state) }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>Store</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>convenience</span> <span style=color:#66d9ef>init</span>(initial state: State, reducer: @escaping Reducer) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.<span style=color:#66d9ef>init</span>(initial: state)
</span></span><span style=display:flex><span>        reduce(with: reducer)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Weak</span>&lt;A: AnyObject&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>weak</span> <span style=color:#66d9ef>var</span> value: A?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>init</span>(<span style=color:#66d9ef>_</span> value: A?) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.value = value
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Listener</span>&lt;State&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> onChange: (State) -&gt; Void
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>init</span>(on change: @escaping (State) -&gt; Void) {
</span></span><span style=display:flex><span>        onChange = change
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=example-usage>Example Usage</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>IntAction</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> increase
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> decrease
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> root = Store&lt;Int, IntAction&gt;(initial: <span style=color:#ae81ff>0</span>) { action, state <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> action {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> .increase:
</span></span><span style=display:flex><span>        state <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> .decrease:
</span></span><span style=display:flex><span>        state <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> sideEffect = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> listener: Any? = root.select {
</span></span><span style=display:flex><span>    sideEffect = $0
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>root.dispatch(.increase)
</span></span><span style=display:flex><span>root.state <span style=color:#75715e>// will be 1</span>
</span></span><span style=display:flex><span>sideEffect <span style=color:#75715e>// will be 1</span>
</span></span><span style=display:flex><span>listener = <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>root.dispatch(.decrease)
</span></span><span style=display:flex><span>root.state <span style=color:#75715e>// will be 0</span>
</span></span><span style=display:flex><span>sideEffect <span style=color:#75715e>// will be 1</span>
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Without explicit support for modularity, supporting multiple reducers as above is probably not needed. Instead some composability functions should be used.</p><p>On the other hand: it is obvious, that are implementing the Redux pattern and embracing unidirectional data flow is relatively easy.</p><p><em><a href=./playground.zip>download this playground</a></em></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/swift>swift</a></li><li><a href=/tags/experiment>experiment</a></li><li><a href=/tags/functional>functional</a></li></ul></nav></div></div></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/vknabel rel=me title=GitHub><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github"/></svg></a><a class=border></a><a class=soc href=https://mastodon.social/@vknabel/ rel=me title=Mastodon><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#at-sign"/></svg></a><a class=border></a></div><div class=footer-info>2025 ¬© Valentin Knabel | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>