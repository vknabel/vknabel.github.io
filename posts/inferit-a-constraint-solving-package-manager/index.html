<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>InferIt: a Constraint Solving Package Manager - vknabel</title><link rel=icon type=image/png href=/images/vknabel.jpg><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The initial idea behind InferIt was to create some mixture of a constraint solver and a dependency manager: you would just tell it what to install and it would gather as much information as possible to install it.
The goal is to fulfill a requirement. InferIt would then try to resolve all variables by trying to fulfill several requirements. If a requirement has been met, the value can be propagated."><meta property="og:image" content><meta property="og:url" content="https://vknabel.com/posts/inferit-a-constraint-solving-package-manager/"><meta property="og:site_name" content="vknabel"><meta property="og:title" content="InferIt: a Constraint Solving Package Manager"><meta property="og:description" content="The initial idea behind InferIt was to create some mixture of a constraint solver and a dependency manager: you would just tell it what to install and it would gather as much information as possible to install it.
The goal is to fulfill a requirement. InferIt would then try to resolve all variables by trying to fulfill several requirements. If a requirement has been met, the value can be propagated."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-15T00:00:00+00:00"><meta property="article:modified_time" content="2019-10-15T00:00:00+00:00"><meta property="article:tag" content="Swift"><meta property="article:tag" content="Experiment"><meta property="article:tag" content="Cli"><meta name=twitter:card content="summary"><meta name=twitter:title content="InferIt: a Constraint Solving Package Manager"><meta name=twitter:description content="The initial idea behind InferIt was to create some mixture of a constraint solver and a dependency manager: you would just tell it what to install and it would gather as much information as possible to install it.
The goal is to fulfill a requirement. InferIt would then try to resolve all variables by trying to fulfill several requirements. If a requirement has been met, the value can be propagated."><script src=https://vknabel.com/js/feather.min.js></script><link href=https://vknabel.com/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://vknabel.com/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://vknabel.com/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css media="(prefers-color-scheme: dark)"><link rel=stylesheet type=text/css href=/css/overrides.css></head><body><div class=content><header><div class=main><a href=https://vknabel.com/>vknabel</a></div><nav><a href=/>blog</a>
<a href=/tils>tils</a>
<a href=/about>about</a>
<a href=/tags>tags</a></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>InferIt: a Constraint Solving Package Manager</h1><div class=meta>Posted on Oct 15, 2019</div></div><section class=body><p>The initial idea behind InferIt was to create some mixture of a constraint solver and a dependency manager: you would just tell it what to install and it would gather as much information as possible to install it.</p><p>The goal is to fulfill a requirement. InferIt would then try to resolve all variables by trying to fulfill several requirements. If a requirement has been met, the value can be propagated.</p><p>The current example does not include side effects or file system lookups. Though this essentially is the key behind this idea and is possible for synchronous operations.</p><p><em>Originally written at 2018-01-15</em></p><h2 id=example>Example</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> c = Context()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> name = Variable&lt;String&gt;(<span style=color:#e6db74>&#34;name&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> githubRepository = Variable&lt;String&gt;(<span style=color:#e6db74>&#34;githubRepository&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> workingDirectory = Variable&lt;Path&gt;(<span style=color:#e6db74>&#34;workingDirectory&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> inferConfig = Variable&lt;InferConfig&gt;(<span style=color:#e6db74>&#34;inferConfig&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> repositoryUrl = Variable&lt;URL&gt;(<span style=color:#e6db74>&#34;respositoryUrl&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> projectDirectory = Variable&lt;Path&gt;(<span style=color:#e6db74>&#34;projectDirectory&#34;</span>)
</span></span><span style=display:flex><span>c.provide(name).by { <span style=color:#e6db74>&#34;vknabel/rock&#34;</span> }
</span></span><span style=display:flex><span>c.provide(githubRepository).when(
</span></span><span style=display:flex><span>  name.with { $0.split(separator: <span style=color:#e6db74>&#34;/&#34;</span>).count == <span style=color:#ae81ff>2</span> },
</span></span><span style=display:flex><span>  { $0 }
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>c.provide(workingDirectory).by { Path.current }
</span></span><span style=display:flex><span>c.provide(inferConfig).by(InferConfig.provider)
</span></span><span style=display:flex><span>c.provide(repositoryUrl).when(
</span></span><span style=display:flex><span>  githubRepository,
</span></span><span style=display:flex><span>  { URL(string: <span style=color:#e6db74>&#34;https://github.com/</span><span style=color:#e6db74>\(</span>$0<span style=color:#e6db74>)</span><span style=color:#e6db74>.git&#34;</span>)<span style=color:#f92672>!</span> }
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>c.provide(repositoryUrl).when(
</span></span><span style=display:flex><span>  name.asUrl.toBeDefined,
</span></span><span style=display:flex><span>  { $0 }
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>c.provide(projectDirectory).when(
</span></span><span style=display:flex><span>  repositoryUrl,
</span></span><span style=display:flex><span>  workingDirectory,
</span></span><span style=display:flex><span>  { <span style=color:#66d9ef>try</span> cloneRepository(from: $0, to: $1) }
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>c.solve(requirement: projectDirectory) <span style=color:#75715e>// this actually runs the application</span>
</span></span></code></pre></div><h2 id=implemenation>Implemenation</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>Foundation</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>InferConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> projectDirectory: String {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>provider</span>() <span style=color:#66d9ef>throws</span> -&gt; InferConfig {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> ResolveError.notImplemented(<span style=color:#66d9ef>#function</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>cloneRepository</span>(from url: URL, to path: Path) <span style=color:#66d9ef>throws</span> -&gt; Path {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> path <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/&#34;</span> <span style=color:#f92672>+</span> url.lastPathComponent
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>ResolveError</span>: Error, CustomStringConvertible {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> notImplemented(String)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> undeclaredVariable(String)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> couldNotResolveVariable(String)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> conditionalCastFailed(Any, Any.<span style=color:#66d9ef>Type</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>from</span>(<span style=color:#66d9ef>_</span> error: Error) -&gt; ResolveError {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> error = error <span style=color:#66d9ef>as</span>? ResolveError {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> error
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      fatalError(<span style=color:#e6db74>&#34;An unknown error occurred: </span><span style=color:#e6db74>\(</span>error<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>var</span> description: String {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#66d9ef>self</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .notImplemented(feature):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Not Implemented: </span><span style=color:#e6db74>\(</span>feature<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .undeclaredVariable(variable):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Variable not declared: </span><span style=color:#e6db74>\(</span>variable<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .couldNotResolveVariable(variable):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Variable could not be resolved: </span><span style=color:#e6db74>\(</span>variable<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .conditionalCastFailed(value, to):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;Type error: </span><span style=color:#e6db74>\(</span>value<span style=color:#e6db74>)</span><span style=color:#e6db74> is no </span><span style=color:#e6db74>\(</span>to<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//: Variables don&#39;t depend on a context.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>protocol</span> <span style=color:#a6e22e>Requirement</span> {
</span></span><span style=display:flex><span>  associatedtype Source
</span></span><span style=display:flex><span>  associatedtype Result
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> sourceName: String { <span style=color:#66d9ef>get</span> }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>apply</span>(state: RequirementState&lt;Source&gt;) -&gt; RequirementState&lt;Result&gt;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Variable</span>&lt;T&gt;: Requirement {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>let</span> sourceName: String
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>init</span>(<span style=color:#66d9ef>_</span> name: String) {
</span></span><span style=display:flex><span>    sourceName = name
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>apply</span>(state: RequirementState&lt;T&gt;) -&gt; RequirementState&lt;T&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> state
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>Requirement</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>with</span>(<span style=color:#66d9ef>_</span> filter: @escaping (Result) -&gt; Bool) -&gt; AnyRequirement&lt;Source, Result&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> AnyRequirement(named: sourceName) { sourceState <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> <span style=color:#66d9ef>self</span>.apply(state: sourceState) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .resolved(source) <span style=color:#66d9ef>where</span> filter(source):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .resolved(source)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> .resolved:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .failed(.notImplemented(<span style=color:#e6db74>&#34;validation mismatch&#34;</span>))
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> .unresolved:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .unresolved
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .failed(error):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .failed(error)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>flatMap</span>&lt;R&gt;(<span style=color:#66d9ef>_</span> transform: @escaping (Result) -&gt; RequirementState&lt;R&gt;) -&gt; AnyRequirement&lt;Source, R&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> AnyRequirement(named: sourceName) { sourceState <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> <span style=color:#66d9ef>self</span>.apply(state: sourceState) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .resolved(source):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> transform(source) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .resolved(result):
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> .resolved(result)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .failed(error):
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> .failed(error)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> .unresolved:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> .unresolved
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .failed(error):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .failed(error)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> .unresolved:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .unresolved
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>map</span>&lt;R&gt;(<span style=color:#66d9ef>_</span> transform: @escaping (Result) -&gt; R) -&gt; AnyRequirement&lt;Source, R&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> AnyRequirement(named: sourceName) { sourceState <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> <span style=color:#66d9ef>self</span>.apply(state: sourceState) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .resolved(source):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .resolved(transform(source))
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .failed(error):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .failed(error)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> .unresolved:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .unresolved
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AnyRequirement</span>&lt;Source, Result&gt;: Requirement {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>typealias</span> Transformation = (RequirementState&lt;Source&gt;) -&gt; RequirementState&lt;Result&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>let</span> sourceName: String
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>let</span> transformation: Transformation
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>init</span>(named name: String, transform: @escaping Transformation) {
</span></span><span style=display:flex><span>    sourceName = name
</span></span><span style=display:flex><span>    transformation = transform
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>apply</span>(state: RequirementState&lt;Source&gt;) -&gt; RequirementState&lt;Result&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> transformation(state)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>RequirementState</span>&lt;Value&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> resolved(Value)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> unresolved
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> failed(ResolveError)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>init</span>(catching factory: () <span style=color:#66d9ef>throws</span> -&gt; Value) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>self</span> = .resolved(<span style=color:#66d9ef>try</span> factory())
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>self</span> = .failed(.from(error))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>init</span>(catching factory: () <span style=color:#66d9ef>throws</span> -&gt; RequirementState&lt;Value&gt;) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>do</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>self</span> = <span style=color:#66d9ef>try</span> factory()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>self</span> = .failed(.from(error))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>map</span>&lt;R&gt;(<span style=color:#66d9ef>_</span> transform: (Value) <span style=color:#66d9ef>throws</span> -&gt; R) <span style=color:#66d9ef>rethrows</span> -&gt; RequirementState&lt;R&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#66d9ef>self</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .resolved(value):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>try</span> .resolved(transform(value))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> .unresolved:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> .unresolved
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .failed(error):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> .failed(error)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>flatMap</span>&lt;R&gt;(<span style=color:#66d9ef>_</span> transform: (Value) <span style=color:#66d9ef>throws</span> -&gt; RequirementState&lt;R&gt;) <span style=color:#66d9ef>rethrows</span> -&gt; RequirementState&lt;R&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#66d9ef>self</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .resolved(value):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>try</span> transform(value)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> .unresolved:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> .unresolved
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .failed(error):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> .failed(error)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>casted</span>&lt;T&gt;(to <span style=color:#66d9ef>_</span>: T.<span style=color:#66d9ef>Type</span> = T.<span style=color:#66d9ef>self</span>) -&gt; RequirementState&lt;T&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#66d9ef>self</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .resolved(value):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> value = value <span style=color:#66d9ef>as</span>? T {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .resolved(value)
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> .failed(.conditionalCastFailed(value, T.<span style=color:#66d9ef>self</span>))
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> .unresolved:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> .unresolved
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .failed(error):
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> .failed(error)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>Variable</span> <span style=color:#66d9ef>where</span> T == String {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> asUrl: Variable&lt;URL?<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Variable&lt;URL?<span style=color:#f92672>&gt;</span>(sourceName) <span style=color:#75715e>// </span><span style=color:#75715e>TODO:</span><span style=color:#75715e> AnyRequirement</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>Variable</span> <span style=color:#66d9ef>where</span> T == URL? {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> toBeDefined: Variable&lt;URL&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Variable&lt;URL&gt;(sourceName) <span style=color:#75715e>// </span><span style=color:#75715e>TODO:</span><span style=color:#75715e> AnyRequirement</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Provider</span>&lt;T&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>let</span> context: Context
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>let</span> variable: Variable&lt;T&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>init</span>(<span style=color:#66d9ef>for</span> variable: Variable&lt;T&gt;, <span style=color:#66d9ef>in</span> context: Context) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>self</span>.context = context
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>self</span>.variable = variable
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>by</span>(<span style=color:#66d9ef>_</span> provider: @escaping () <span style=color:#66d9ef>throws</span> -&gt; T) {
</span></span><span style=display:flex><span>    context.bind(variable: variable, catching: provider)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>when</span>&lt;R: Requirement&gt;(<span style=color:#66d9ef>_</span> precondition: R, <span style=color:#66d9ef>_</span> resolve: @escaping (R.Result) <span style=color:#66d9ef>throws</span> -&gt; T) {
</span></span><span style=display:flex><span>    context.bind(variable: variable, to: {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> solution: RequirementState&lt;R.Result&gt; = <span style=color:#66d9ef>self</span>.context.solve(requirement: precondition)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> solution.flatMap { (value: R.Result) -&gt; RequirementState&lt;T&gt; <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>        RequirementState { <span style=color:#66d9ef>try</span> resolve(value) }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>when</span>&lt;R0: Requirement, R1: Requirement&gt;(<span style=color:#66d9ef>_</span> precondition0: R0, <span style=color:#66d9ef>_</span> precondition1: R1, <span style=color:#66d9ef>_</span> resolve: @escaping (R0.Result, R1.Result) <span style=color:#66d9ef>throws</span> -&gt; T) {
</span></span><span style=display:flex><span>    context.bind(variable: variable, to: {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> solution0 = { <span style=color:#66d9ef>self</span>.context.solve(requirement: precondition0) }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>let</span> solution1 = { <span style=color:#66d9ef>self</span>.context.solve(requirement: precondition1) }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> solution0().flatMap { (value0: R0.Result) -&gt; RequirementState&lt;T&gt; <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>        solution1().flatMap { (value1: R1.Result) <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>          RequirementState { <span style=color:#66d9ef>try</span> resolve(value0, value1) }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fileprivate <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>VariableBindings</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>typealias</span> Resolver = () -&gt; RequirementState&lt;Any&gt;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> resolvers: [Resolver] = []
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> state: RequirementState&lt;Any&gt; = .unresolved
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> bindings: [String: VariableBindings] = [:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>provide</span>&lt;T&gt;(<span style=color:#66d9ef>_</span> variable: Variable&lt;T&gt;) -&gt; Provider&lt;T&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Provider(<span style=color:#66d9ef>for</span>: variable, <span style=color:#66d9ef>in</span>: <span style=color:#66d9ef>self</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>bind</span>&lt;T&gt;(variable: Variable&lt;T&gt;, catching resolver: @escaping () <span style=color:#66d9ef>throws</span> -&gt; T) {
</span></span><span style=display:flex><span>    bind(variable: variable) {
</span></span><span style=display:flex><span>      RequirementState(catching: resolver)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>bind</span>&lt;T&gt;(variable: Variable&lt;T&gt;, to resolver: @escaping () -&gt; RequirementState&lt;T&gt;) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> binding = bindings[variable.sourceName] ?? VariableBindings()
</span></span><span style=display:flex><span>    binding.resolvers.append({ resolver().casted() })
</span></span><span style=display:flex><span>    bindings[variable.sourceName] = binding
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>log</span>(resolver: VariableBindings.Resolver, <span style=color:#66d9ef>for</span> sourceName: String) -&gt; RequirementState&lt;Any&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result = resolver()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> result {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .failed(error):
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#34;[FAILED] </span><span style=color:#e6db74>\(</span>sourceName<span style=color:#e6db74>)</span><span style=color:#e6db74> with </span><span style=color:#e6db74>\(</span>error<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> .resolved(value):
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#34;[SOLVED] </span><span style=color:#e6db74>\(</span>sourceName<span style=color:#e6db74>)</span><span style=color:#e6db74> as </span><span style=color:#e6db74>\(</span>String<span style=color:#e6db74>(</span>reflecting: value<span style=color:#e6db74>))</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> .unresolved:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>solvePure</span>(sourceName: String) -&gt; RequirementState&lt;Any&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>guard</span> <span style=color:#66d9ef>let</span> binding = bindings[sourceName] <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      print(<span style=color:#e6db74>&#34;[FAILED] No rules for </span><span style=color:#e6db74>\(</span>sourceName<span style=color:#e6db74>)</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> .failed(.undeclaredVariable(sourceName))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> binding.state {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> .unresolved:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> binding.resolvers.reduce(.failed(.couldNotResolveVariable(sourceName))) { result, resolver <span style=color:#66d9ef>in</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>case</span> .unresolved = result {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> resolver()
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>case</span> .failed(.couldNotResolveVariable(sourceName)) = result {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> log(resolver: resolver, <span style=color:#66d9ef>for</span>: sourceName)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>let</span> result:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>solve</span>(sourceName: String) -&gt; RequirementState&lt;Any&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> result = solvePure(sourceName: sourceName)
</span></span><span style=display:flex><span>    bindings[sourceName]?.state = result
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>solve</span>&lt;R: Requirement&gt;(requirement: R) -&gt; RequirementState&lt;R.Result&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> variableState: RequirementState&lt;R.Source&gt; = solve(sourceName: requirement.sourceName).casted()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> requirement.apply(state: variableState)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Thus I still believe this to be an interesting topic, the amount of variables and requirements seem to explode and to be hard to debug without any additional tools.</p><p>Furthermore this constraint solver still operates synchronously. To be production ready this needs to be implemented asynchrously, which would then enhance.</p><p><em><a href=./playground.zip>download this playground</a></em></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/swift>swift</a></li><li><a href=/tags/experiment>experiment</a></li><li><a href=/tags/cli>cli</a></li></ul></nav></div></div></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/vknabel rel=me title=GitHub><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github"/></svg></a><a class=border></a><a class=soc href=https://mastodon.social/@vknabel/ rel=me title=Mastodon><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#at-sign"/></svg></a><a class=border></a></div><div class=footer-info>2025 © Valentin Knabel | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>